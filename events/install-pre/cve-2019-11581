#!/bin/bash -eu
## Checks if app is vulnerable to cve-2019-11581 (https://confluence.atlassian.com/jira/jira-security-advisory-2019-07-10-973486595.html)
## If so, sets a hg guard so that the 'cve-2019-11581' mitigation hg patch is applied.

. "$(dirname "$(readlink -f ${BASH_SOURCE[0]})")"/.common.sh

# Affects Jira <7.13.5 and <8.2.3
affected() {
	[[ $ATL_PRODUCT = jira ]] || return 1
	local vmajor=${ATL_VER%%.*} # Before the first dot
	case "$vmajor" in
	7)
		#log "major 7"
		version_lessthan "$ATL_VER" 7.13.5 && return 0
		;;
	esac
	version_lessthan "$ATL_VER" 8.2.3
	return $?
}

# We'll usually be called from our app workingcopy directory.
#cd "$ATL_APPDIR"
if affected; then
	log "$ATL_PRODUCT $ATL_VER is vulnerable to cve-2019-15001"
	addguard cve-2019-11581
else
	removeguard cve-2019-11581
fi
