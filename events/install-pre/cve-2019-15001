#!/bin/bash -eu
## Checks if app is vulnerable to cve-2019-15001 (https://confluence.atlassian.com/jira/jira-security-advisory-2019-09-18-976766250.html)
## If so, sets a hg guard so that the 'cve-2019-15001' mitigation hg patch is applied.

. "$(dirname "$(readlink -f ${BASH_SOURCE[0]})")"/.common.sh

# Affects Jira <7.13.8, <8.3.4, <8.4.1
affected() {
	[[ $ATL_PRODUCT = jira ]] || return 1
	local vmajor=${ATL_VER%%.*} # Before the first dot
	case "$vmajor" in
	7)
		#log "major 7"
		version_lessthan "$ATL_VER" 7.13.8 && return 0
		;;
	8)
		vminor=${ATL_VER#${vmajor}\.}
		vminor=${vminor%%.*}
		#log "major 8 minor $vminor"
		case "$vminor" in
		3)
			version_lessthan "$ATL_VER" 8.3.4
			return $?
			;;
		4)
			version_lessthan "$ATL_VER" 8.4.1
			return $?
			;;
		esac
		;;
	esac
	version_lessthan "$ATL_VER" 8.4.1
	return $?
}

if affected; then
	log "$ATL_PRODUCT $ATL_VER is vulnerable to cve-2019-15001. Enabling guard for patch"
	addguard cve-2019-15001
else
	removeguard cve-2019-15001
fi
