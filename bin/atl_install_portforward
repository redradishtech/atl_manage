#!/bin/bash -eu
# shellcheck source=/opt/atl_manage/lib/common.sh
source "$ATL_MANAGE/lib/common.sh" --

main() {
	[[ $EUID = 0 ]] || fail "Please run as root"
	# {{{ Parseopts
	set -eu # Rely on quick failure from getopt if wrong arg is passed
	#https://stackoverflow.com/questions/192249/how-do-i-parse-command-line-arguments-in-bash/38153758
	local PARSED
	PARSED=$(getopt --options 'h' --longoptions 'help' --name "$0" -- "$@")
	# use eval with "$PARSED" to properly handle the quoting
	eval set -- "$PARSED"
	# Note, no commit=. We check on the variable's defined'ness rather than value below, so that we can distinguish between '--commit' and '--commit=foo'
	while true; do
		case "$1" in
		-h | --help) usage ;;
		--)
			shift
			break
			;;
		*) usage "Invalid option: $1" ;;
		esac
		shift
	done
	# }}}
	[[ $# = 2 ]] || usage
	from="$1"
	shift
	to="$1"
	shift
	log "Setting up portforward from $from to $to"
	case "$(cat /etc/machine-id)" in
	"$to")
		log "SEtting from"
		;;
	"$from")
		log "Setting to"
		;;
	*)
		error "This server is neither $from not $to"
		;;
	esac

}

usage() {
	cat <<EOF
$*
Purpose: Forwards a port from one server to another persistently, over a SSH connection

Usage:
atl_plugins fromserver toserver

Where <fromserver> and <toserver> are machine-ids visible in /etc/machine-id ($(cat /etc/machine-id) on this server)

EOF
	exit 2
}

main "$@"
