#!/bin/bash -eu

if [[ ${1:-} = --help ]]; then
	echo >&2 "Prints the users who fail login the most, currently or in total"
	echo >&2 "See also https://community.atlassian.com/t5/Jira-Core-questions/How-to-find-IP-of-failed-login-attempts/qaq-p/2042#U1134917"
	exit 1
fi

echo "WITH userlogins AS (
        SELECT DISTINCT
        user_name
        , email_address
        , timestamp with time zone 'epoch'+lastfail::numeric/1000 * INTERVAL '1 second' AS lastfail
        , failcount_current::numeric AS failcount_current
        , failcount_total::numeric AS failcount_total
        , cwd_user.directory_id
        FROM
        cwd_user
        JOIN (select * from cwd_directory WHERE active=1) as cwd_directory ON cwd_user.directory_id = cwd_directory.id
        JOIN cwd_membership ON cwd_membership.child_name=cwd_user.lower_user_name
        JOIN (
                select * from globalpermissionentry WHERE permission IN ('USE', 'ADMINISTER')
             ) AS globalpermissionentry ON cwd_membership.lower_parent_name=globalpermissionentry.group_id
             LEFT JOIN (select user_id, attribute_value AS lastfail from cwd_user_attributes WHERE attribute_name in ('login.lastFailedLoginMillis')) a ON a.user_id=cwd_user.id
             LEFT JOIN (select user_id, attribute_value AS failcount_current from cwd_user_attributes WHERE attribute_name in ('login.currentFailedCount')) b ON b.user_id=cwd_user.id
             LEFT JOIN (select user_id, attribute_value AS failcount_total from cwd_user_attributes WHERE attribute_name in ('login.totalFailedCount')) c ON c.user_id=cwd_user.id
        WHERE cwd_user.active=1
)
SELECT distinct user_name
, email_address
, to_char(lastfail, 'YYYY-MM-DD') AS lastfail
, failcount_current
, failcount_total
FROM userlogins
ORDER BY failcount_total desc nulls last ;"
