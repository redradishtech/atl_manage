#!/bin/bash -eu

if [[ ${1:-} = --help ]]; then
	echo >&2 "Purpose: SQL to print active JIRA users and their last login"
	echo >&2 "Usage: atl_pg_usage_jira_userlogins [extrasql] | atl_psql"
	echo >&2
	echo >&2 "atl_pg_usage_jira_userlogins \"(lastlogin < now() - '6 months'::interval OR lastlogin is null)  ORDER BY lastlogin desc nulls last \"   | atl_psql -e"
	exit 1
	exit 1
fi

echo "WITH userlogins AS (
        SELECT DISTINCT
        user_name
        , email_address
        , cwd_user.created_date
        , timestamp with time zone 'epoch'+attribute_value::numeric/1000 * INTERVAL '1 second' AS lastlogin
        , cwd_user.directory_id
        FROM
        cwd_user
	JOIN (select * from cwd_directory WHERE active=1) as CWD_directory ON cwd_user.directory_id = cwd_directory.id
        JOIN cwd_membership ON cwd_membership.child_name=cwd_user.lower_user_name
        JOIN (
                select * from globalpermissionentry WHERE permission IN ('USE', 'ADMINISTER')
             ) AS globalpermissionentry ON cwd_membership.lower_parent_name=globalpermissionentry.group_id
	     LEFT JOIN (select * from cwd_user_attributes WHERE attribute_name in ('login.lastLoginMillis')) cwd_user_attributes ON user_id=cwd_user.id
        WHERE cwd_user.active=1
)
SELECT distinct user_name
, email_address
, to_char(created_date, 'YYYY-MM-DD') AS created
, to_char(lastlogin, 'YYYY-MM-DD') AS lastlogin
FROM userlogins"

if [[ $# != 0 ]]; then
	echo " WHERE $*;"
else
	echo "ORDER BY lastlogin ASC"
fi
